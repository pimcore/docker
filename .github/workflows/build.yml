name: Docker BUILD

on:
    workflow_dispatch:
    schedule:
        - cron: '30 2 * * *' # run a build at least once a day to keep the images up to date
    push:
        branches:
            - main

env:
    IMAGE_NAME: pimcore/pimcore

jobs:
    build-php:
        name: "Build PHP images"
        runs-on: ubuntu-latest
        strategy:
            matrix:
                php: [7.4, '8.0']
                variant: [cli, fpm]
                distro: [bullseye, buster]
                debug: [debug, no-debug]
                exclude:
                    -   php: 7.4
                        distro: bullseye
                    -   php: '8.0'
                        distro: buster

        steps:
            -   uses: actions/checkout@v2

            -   name: run update script
                run: |
                    ./update.sh

            -   name: Login to DockerHub Registry
                run: echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

            -   name: Set up QEMU
                uses: docker/setup-qemu-action@v1
            -   name: Set up Buildx
                uses: docker/setup-buildx-action@v1

            -   name: Build image
                run: |
                    IMAGE_ID=$IMAGE_NAME
                    DOCKERFILE="${{ matrix.php }}/${{ matrix.variant }}/${{ matrix.distro }}/${{ matrix.debug }}"
                    DOCKER_TAG="PHP${{ matrix.php }}-${{ matrix.variant }}"

                    ls -la $DOCKERFILE

                    cd $DOCKERFILE

                    ls -la .

                    if [ "${{ matrix.debug }}" == "debug" ]; then
                        DOCKER_TAG="$DOCKER_TAG-debug"
                    fi

                    docker buildx build --output "type=image,push=false" \
                        --platform linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7,linux/arm/v8 \
                        --build-arg VERSION=$IMAGE_ID \
                        --tag $IMAGE_ID:$DOCKER_TAG .
            -   name: Push image
                run: |
                    IMAGE_ID=$IMAGE_NAME
                    DOCKERFILE="${{ matrix.php }}/${{ matrix.variant }}/${{ matrix.distro }}/${{ matrix.debug }}"
                    DOCKER_TAG="PHP${{ matrix.php }}-${{ matrix.variant }}"

                    cd $DOCKERFILE

                    if [ "${{ matrix.debug }}" == "debug" ]; then
                        DOCKER_TAG="$DOCKER_TAG-debug"
                    fi

                    echo "Tag $DOCKER_TAG"

                    docker buildx build --output "type=image,push=true" \
                        --platform linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7,linux/arm/v8 \
                        --build-arg VERSION=$IMAGE_ID \
                        --tag $IMAGE_ID:$DOCKER_TAG .

    build-supervisor:
        name: "Build supervisord image"
        needs: build-php
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2

            - name: Login to DockerHub Registry
              run: echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

            - name: Build image
              run: |
                  cd supervisord

                  ls -la .

                  docker build . -t supervisord

            - name: Push image
              run: |
                  IMAGE_ID=$IMAGE_NAME

                  docker tag supervisord $IMAGE_ID:supervisord
                  docker push $IMAGE_ID:supervisord
